# 7-分析恶意Windows程序

## Windows API

### 类型和匈牙利表达法

`DWORD` 32位无符号整数      /    `WORD`  16位无符号整数

API函数标识符/匈牙利表达法/前缀命名模式，来表示变量类型，ex：以`dw`开头标识一个32位无符号整数

`Windows API`的常见类型

| 类型和前缀             | 描述                                       |
| :---------------- | :--------------------------------------- |
| `WORD(w)`         | 16位无符号数值                                 |
| `DWORD(dw)`       | 32位无符号数值                                 |
| `Handles(H)`      | 对象索引，这一句柄应该只被`Windows API`来操作，例如`HModule`/`HInstance`/`HKey` |
| `Long Pointer(L)` | 指向另一类型的指针，`LPByte`是指向字节的指针，`LPCSTR`是指向字符串的指针 |
| `Callback`        | 表示一个将会被`Windows API`调用的函数                |

### 句柄

句柄是在操作系统中被打开或者被创建的项，比如一个窗口/进程/模块/菜单/文件等。
你能对句柄做的唯一的事情，就是保存它，在后续函数调用中实用它来引用同一个对象。

例如，`CreateWindowWx`函数,返回一个`HWND`，一个窗口句柄。当你要对这个窗口做什么的时候，比如调用`DestroyWindow`，都需要使用这个句柄。

### 文件系统函数

---独特的文件名 或 修改既有的文件名 是明显的基于主机的感染现象

- `CreateFile`	

    创建/打开文件

- `ReadFile` / `WriteFile`   

    文件作为流--读/写。第一次调用ReadFile读取一个文件，第二次调用会继续读取。

- `CreateFileMapping` / `MapViewOfFile`

    文件映射：将文件加载到内存中。`CreateFileMapping`从磁盘加载一个文件到内存中， `MapViewOfFile`返回指向映射的基地址指针，用来访问内存中的文件。 - - - 程序调用两个函数，用 `MapViewOfFile` 返回的指针，在文件的任意位置进行读取和写入。



### 特殊文件

不能通过 `C:\docs` 这种进行访问。特殊文件可以作为字符串参数传递给任何文件操作函数。

- 共享文件

    以 `\\serverName\share` 或  `\\?\serverName\share` 开头命名的特殊文件。用来访问共享目录中的目录or文件。`\\?\` 表示禁用任何的字符串解析，并且允许访问长文件名

- 通过名字空间访问的文件

    命名空间

- 备用数据流



## Windows注册表

Windows注册表 用来保存OS与程序的配置信息。恶意代码经常所使用注册表来完成持久驻留或者存储配置数据。
- 根键 
    5个
- 子键
- 键
    注册表中的文件夹：根键/子键
- 值项
    配对的名字和值
- 值或数据
    存储在注册表项中的数据

### 注册表根键
5个根键
- HKEY_LOCAL_MACHINE
- HKEY_CURRENT_USER
- HKEY_CLASSES_ROOT
- HKEY_CURRENT_CONFIG
- HKEY_USERS

### Regedit
注册表编辑器，windows内建的用来查看和编辑注册表的工具。

### 自启动程序
设置程序自启动：向Run子键中写入项
Autoruns，列举了os启动时会自动启动运行的代码。列举了自启动的可执行文件/加载到Internet Explorer和其他程序中的DLL程序/加载到内核的驱动。
Autoruns会在注册表中检查25-30个位置来找到被设计成自动运行的代码，但并不会列出所有的项。

### 常用注册表函数

- RegOpenKeyEx
    打开一个注册表进行编辑和查询
- RegSetValueEx
    添加一个新值到注册表并设置值
- RegGetValue
    返回注册表中一个值项的值

### 使用.reg文件的注册表脚本
类似于修改注册表的标本，双击.reg文件时自动合并文件包含的信息来修改注册表。
```
Windows Registry Editor Version 5.00  #注册表编辑器的版本 5.00对应Windows XP

[HKLM\SOFTWARE\Microsoft\Windows\CurrentVersion\Run] #要被修改的键
"MaliciousValue"="C:\Windows\evil.exe" #值的名字和数据
```
添加一个名字为MaliciousValue的键值，在os每次引导时自动运行C:\Windows\evil.exe

## 网络API

### 伯克利兼容套接字
WinSock库，主要在ws2_32.dll中
|函数|描述|
|:--|:--|
|socket
|bind
|listen
|accept|等待/接收一个远程socket的连接|
|send
|recv

### 网络的服务器和客户端

Server：socket  bind     listen  accept  send    recv
Client：socket   connect send recv
error： WSAGetLastError
WSAStartup 初始化Win32 sockets系统

### WinINet API
WinINet API 函数保存在Wininet.dll中。WinINet API实现了应用层协议。
- InternetOpen
- IntnetOpenUrl
- IntnetReadFile和ReadFile


## 跟踪恶意代码的运行

### DLL

动态链接库DLL - 多个应用程序中共享代码的Windows特有方式。一个DLL是不能独自运行的可执行文件，但可以导出被其他应用程序使用的函数。
DLL程序使用内存可以在正在运行的进程之间共享。

### 进程

**创建一个新进程**
CreateProcess
恶意代码经常使用CreateProcess来创建一个简单的远程shell。CreateProcess参数之一，STARTUPINFO，包含一个进程的标准输入/标准输出/标准错误流的句柄。恶意程序可以将这些值设置为套接字，那么这个程序写入标准输出时就会写到套接字上，从而攻击者执行远程shell。


### 线程

**一个进程中的所有线程共享同样的内存空间，但是每一个有它自己的处理器/寄存器/栈。**

**线程上下文**

当一个线程运行时，它对CPU有完全的控制权。线程切换时，将状态保存到 `线程上下文` 中，回来时再加载。线程不会干扰其他线程的寄存器or标志。

**创建一个线程**



### 使用互斥量的进程间协作

互斥量：全局对象，协调多个进程和线程 / 控制对共享资源的访问

同一时刻只有一个线程拥有互斥量。经常硬编码。

### 服务

Windows允许通过使用服务，来使任务作为后台应用程序运行，不需要他们自己的线程or进程；代码被Windows服务管理器调度和运行，没有用户输入。在Windows操作系统的任何指定时间，都会有多个服务在运行。

服务通常作为SYSTEM或其他特权账户运行。

维护持久化驻留。可以设置为OS启动时自动运行，并且可能甚至不在任务管理器中作为一个

### 组件对象模型

### 异常



## 用户和内核模式

## 原生API

## 小结



