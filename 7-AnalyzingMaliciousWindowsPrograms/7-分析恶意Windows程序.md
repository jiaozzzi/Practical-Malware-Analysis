---
title: 7-分析恶意Windows程序
tags: 
- PracticalMalwareAnalysis
---
# 7-分析恶意Windows程序

## Windows API

### 类型和匈牙利表达法

DWORD 32位无符号整数      /    WORD  16位无符号整数

API函数标识符/匈牙利表达法/前缀命名模式，来表示变量类型，ex：以dw开头标识一个32位无符号整数

Windows API的常见类型

|类型和前缀|描述|
|:--|:--|
|WORD(w)|16位无符号数值|
|DWORD(dw)|32位无符号数值|
|Handles(H)|对象索引，这一句柄应该只被Windows API来操作，例如HModule/HInstance/HKey|
|Long Pointer(L)|指向另一类型的指针，LPByte是指向字节的指针，LPCSTR是指向字符串的指针|
|Callback|表示一个将会被Windows API调用的函数|

### 句柄

句柄是在操作系统中被打开或者被创建的项，比如一个窗口/进程/模块/菜单/文件等。
你能对句柄

### 文件系统函数

### 特殊文件

## Windows注册表
Windows注册表 用来保存OS与程序的配置信息。恶意代码经常所使用注册表来完成持久驻留或者存储配置数据。
- 根键 
    5个
- 子键
- 键
    注册表中的文件夹：根键/子键
- 值项
    配对的名字和值
- 值或数据
    存储在注册表项中的数据

### 注册表根键
5个根键
- HKEY_LOCAL_MACHINE
- HKEY_CURRENT_USER
- HKEY_CLASSES_ROOT
- HKEY_CURRENT_CONFIG
- HKEY_USERS

### Regedit
注册表编辑器，windows内建的用来查看和编辑注册表的工具。

### 自启动程序
设置程序自启动：向Run子键中写入项
Autoruns，列举了os启动时会自动启动运行的代码。列举了自启动的可执行文件/加载到Internet Explorer和其他程序中的DLL程序/加载到内核的驱动。
Autoruns会在注册表中检查25-30个位置来找到被设计成自动运行的代码，但并不会列出所有的项。

### 常用注册表函数

- RegOpenKeyEx
    打开一个注册表进行编辑和查询
- RegSetValueEx
    添加一个新值到注册表并设置值
- RegGetValue
    返回注册表中一个值项的值

### 使用.reg文件的注册表脚本
类似于修改注册表的标本，双击.reg文件时自动合并文件包含的信息来修改注册表。
```
Windows Registry Editor Version 5.00  #注册表编辑器的版本 5.00对应Windows XP

[HKLM\SOFTWARE\Microsoft\Windows\CurrentVersion\Run] #要被修改的键
"MaliciousValue"="C:\Windows\evil.exe" #值的名字和数据
```
添加一个名字为MaliciousValue的键值，在os每次引导时自动运行C:\Windows\evil.exe

## 网络API

### 伯克利兼容套接字
WinSock库，主要在ws2_32.dll中
|函数|描述|
|:--|:--|
|socket
|bind
|listen
|accept|等待/接收一个远程socket的连接|
|send
|recv

### 网络的服务器和客户端

Server：socket  bind     listen  accept  send    recv
Client：socket   connect send recv
error： WSAGetLastError
WSAStartup 初始化Win32 sockets系统

### WinINet API
WinINet API 函数保存在Wininet.dll中。WinINet API实现了应用层协议。
- InternetOpen
- IntnetOpenUrl
- IntnetReadFile和ReadFile


## 跟踪恶意代码的运行

### DLL

动态链接库DLL - 多个应用程序中共享代码的Windows特有方式。一个DLL是不能独自运行的可执行文件，但可以导出被其他应用程序使用的函数。
DLL程序使用内存可以在正在运行的进程之间共享。

### 进程

**创建一个新进程**
CreateProcess
恶意代码经常使用CreateProcess来创建一个简单的远程shell。CreateProcess参数之一，STARTUPINFO，包含一个进程的标准输入/标准输出/标准错误流的句柄。恶意程序可以将这些值设置为套接字，那么这个程序写入标准输出时就会写到套接字上，从而攻击者执行远程shell。


### 线程

一个进程中的所有线程共享同样的内存空间，但是每一个有它自己的处理器/寄存器/栈。

**线程上下文**
**创建一个线程**

### 使用互斥量的进程间协作

### 服务

### 组件对象模型

### 异常

## 用户和内核模式

## 原生API

## 小结



