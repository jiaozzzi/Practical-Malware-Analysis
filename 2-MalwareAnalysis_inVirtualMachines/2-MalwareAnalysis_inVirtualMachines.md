# 在虚拟机中分析恶意代码

坑没写完 -- 

----

建立安全的环境

- 物理主机与隔离网络

  优点：可以在真实环境中运行恶意代码

  缺点：缺乏互联网连接（许多恶意代码通过互联网来进行自身更新 / 获取命令 / 接受控制....）；可能很难被移除（使用OS的备份镜像）

- 虚拟机

  恶意代码会检测虚拟机 / 可能不会正确执行 and 阻挠分析

## 虚拟机的结构

![2-1](C:\Users\Ghz\Desktop\Practical-Malware-Analysis\2-MalwareAnalysis_inVirtualMachines\images\2-1.PNG)

虚拟机上运行的操作系统和宿主操作系统是相互隔离的。如果malware破坏了虚拟机，可以直接在虚拟机中重装系统or回滚到干净的状态。

## 创建恶意代码分析机

虚拟机配置 + windows xp系统 + VMware Tools

### 配置VMware

Network Adapter：Custom(VMnet4)    +   VMnet0

### 断开网络

移除网络适配器  or  VM -- Removable Devices将适配器从网络上断开

### 创建主机模式网络

 主机模式网络 Host-only，在宿主os和客户os之间创建一个隔离的私有局域网。这个局域网不会连接到互联网。

> 宿主os的补丁要打好，配置严格规则的防火墙来限制从虚拟机过来的网络连接。避免恶意代码攻陷你的宿主os

![2-2](C:\Users\Ghz\Desktop\Practical-Malware-Analysis\2-MalwareAnalysis_inVirtualMachines\images\2-2.PNG)

Host-only模式网络，VMware在宿主machine和虚拟机中都创建一个虚拟网络适配器并将它们相连，而与宿主的物理网络适配器则没有关联，宿主的物理网络适配器仍然连接到外部网络（互联网）

### 使用多个虚拟机

多个虚拟机通过一个私有局域网相连，断开这个局域网和宿主主机的连接。

![2-3](C:\Users\Ghz\Desktop\Practical-Malware-Analysis\2-MalwareAnalysis_inVirtualMachines\images\2-3.PNG)

上图中，两个虚拟机相连，可以一个用来运行恶意代码，另一个提供一些必要的网络服务。两个虚拟机都连接到VMNet虚拟交换机上。

创建虚拟机分组 File -- New -- Team

## 使用恶意代码分析机

## 使用VMware进行恶意代码分析的风险

1. 一些恶意代码会检测虚拟机 and 在虚拟机中会有不同的执行过程
2. VMware安全漏洞 -- 被利用，导致宿主os崩溃 or 恶意代码运行在宿主os
3. 不管采取什么预防措施，分析恶意代码总会面临风险 --- 避免在任何关键or敏感的宿主机上进行

## 记录/重放：重复计算机运行轨迹

## 小结