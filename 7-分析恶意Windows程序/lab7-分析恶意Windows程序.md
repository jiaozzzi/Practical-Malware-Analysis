---
title: lab7-分析恶意Windows程序
tags: 
- PracticalMalwareAnalysis
---

## lab 7-1

分析lab07-01.exe
1. 当计算机重启之后，这个程序如何保证它继续运行(达到持久化驻留)
2. 为什么这个程序会使用一个互斥量
3. 可以用来检测这个程序的基于主机特征是什么
4. 检测这个恶意代码的基于网络特征是什么
5. 这个程序的目的是什么
6. 这个程序什么时候完成执行

## lab 7-2
分析lab07-02.exe
1. 这个程序如何完成持久化驻留
2. 这个程序的目的是什么
3. 这个程序什么时候完成执行

## lab7-3
执行前获得的恶意的可执行程序 lab07-03.exe 以及 lab07-03.dll，(恶意代码一旦执行就可能发生改变)，两个文件在受害者的机器上的同一个目录下被发现，如果运行这个程序，要确保两个文件在分析机器上的同一个目录中。一个以127开始的IP字符串(回环地址)连接到了本地机器。
warning：这个实验可能会造成损害，虚拟机记得事先做快照。then，动静态结合分析，聚焦全局视图，避免陷入细节。
1. 这个程序如何完成持久化驻留，来确保在计算机重启后仍能继续运行
2. 恶意代码基于主机特征（两个）是什么
3. 这个程序的目的是什么
4. 一旦这个恶意代码被安装，如何清除

----

题目如上，当然要先自己尝试一下了 (ง •_•)ง

---

## lab 7-1

### 分析

我们用 `PEiD` 来看一下导入函数

- `ADVAPI32.dll`

    ![](images/1.png)

    `OpenSCManager`函数返回服务控制管理器的句柄，`CreateService`函数添加一个新的服务到服务控制管理器，这两个API函数说明恶意程序很可能会创建服务来保证计算机重启后还能继续运行。

- `WININET.dll`

    ![](images/2.png)

    出现了 `InternetOpenUrl` 函数以及 `InternetOpen` 函数，说明这个程序可能会连接到 某个网址。

下面用 `IDAPro` 来做静态分析

`main`函数如下

![](images/3.png)

可以看到 `StartServiceCtrlDispatcher` 函数，来实现一个服务，指定服务控制管理器所调用的服务控制函数，即 `sub_401040`。看 `main`函数只能知道会有一个服务要运行。
下面看一下 `sub_401040`。

程序首先调用了 `OpenMutexA`函数，它会获得一个 `HGL345`的互斥量，如果 `HGL345` 这个互斥量存在 则红线跳转，那么程序就会调用 `ExitProcess` ；如果互斥量不存在则绿线跳转，调用`CreateMutexA` 创建名为 `HGL345`的互斥量，保证恶意程序在任意时刻只有一份实例在系统上运行。

继续，看到 `OpenSCManagerA` 来打开服务控制管理器的句柄，恶意程序可以添加or修改服务。然后 调用 `GetCurrentProcess` 来获取当前进程的伪句柄，（伪句柄也就是说这个函数所获取的句柄可以被复制但是不能被继承，而且获取的这个句柄在程序的最后也不需要调用 `closeHandle`来关闭句柄）。往下，`GetModuleFileNameA`用以获取当前所运行程序或一个被加载的`DLL`的完整路径，后面调用 `CreateServiceA` 来创建一个服务，这个函数的参数 `lpBinaryPathName` 保存了刚才我们获取的当前运行程序的完整路径名， `dwStartType 表示服务的启动选项` = 2 = `SERVICE_AUTO_STSRT` 表示服务在系统启动时自动运行。下一个 `dwServiceType` 表示服务的类型 = 10h 表示该服务运行于独立进程的服务程序。服务程序的名称即为`Malservice`。

继续，`xor edx,edx` 即将 `edx`置为0。然后看到程序使用了`SystemTime`，将`wYear`/`wDayOfWeek`/`wDayOfWeek`/`wDayOfWeek` = `edx` = 0，then， `wYear = 834h = 2100` 即2100年1月1日的午夜。then，`SystemTimeToFileTime` 将系统时间赋给文件时间。then，`CreateWaitableTimerA`/ `SetWaitableTimer`/ `WaitForSingleObject`。我们看一下 `SetWaitableTimer`的参数，`FileTime = edx = lpDueTime`表示要等待的时间，然后调用 `WaitForSingleObject`进入等待，一直到2100年1月1日的午夜这个程序才会继续执行。

如果现在的时间已经到了2100年1月1日的午夜，那么红线往下，`esi`作为计数器 = 14h = 20 进入循环，循环最后` dec  esi`，即 `esi--`，所以就是这个循环要执行20次。调用 `CreateThread`，参数 `lpStartAddress `表明哪些函数在线程创建后执行。查看参数，`InternetOpenA`初始化网络连接，进入循环，调用  `InternetOpenUrl`，循环末尾是 jmp无条件跳转 回起始位置，也就是说这是一个无限循环，不断调用 `InternetOpenUrl`来访问网址 "http://www.malwareanalysisbook.com"，返回上一层循环，上一层循环是循环20次，也就是要创建20个线程，每个线程不断调用`InternetOpenUrl`来访问网址。

所以，这个恶意程序就是一个`ddos`，也就是分布式拒绝访问的攻击。

### 回答问题：

1. 当计算机重启之后，这个程序如何保证它继续运行(达到持久化驻留)
    程序调用 `CreateService`来创建了一个服务 `MalService`来保证每次在系统重启后自动运行
2. 为什么这个程序会使用一个互斥量
    使用一个互斥量来保证程序在同一时间是有一份实例在运行
3. 可以用来检测这个程序的基于主机特征是什么
    - 互斥量 `HGL345`
    - 创建的服务 `MalService`
4. 检测这个恶意代码的基于网络特征是什么
    - 用户代理 "Internet Explorer 8.0"
    - url "http://www.malwareanalysisbook.com"
5. 这个程序的目的是什么
    等到2100年1月1日的午夜，创建线程，每个线程无限循环访问url "http://www.malwareanalysisbook.com"，就是一个分布式拒绝服务攻击。
6. 这个程序什么时候完成执行
    永远不会完成。

---

## lab 7-2
### 分析



---


## lab 7-3


### 分析