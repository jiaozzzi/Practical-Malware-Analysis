# 动态分析基础技术

## 沙箱：简便但粗糙的方法

沙箱是一种在安全环境里运行不信任程序的安全机制，不必担心伤害到真正的系统。沙箱包含一个虚拟环境，通过某种方式模拟网络服务，以确保被测试的软件或者恶意代码能正确执行。

### 使用恶意代码沙箱

很多分析恶意代码的沙箱 --- 都提供免费分析恶意代码的服务。 

Norman沙箱、GFI沙箱等 --- 都会提供一个分析报告 -- 执行的网络行为 / 文件操作 / 互斥量列表 / 对注册表的修改活动 / VirusTotal的扫描结果 等

### 沙箱的缺点

1.  沙箱只能简单运行可执行程序，不能带有命令行选项。如果恶意代码需要一些命令才能执行，在不提供选项的条件下，任何代码都不会执行。
2.  如果你分析的恶意代码样本是一个后门程序，需要等待一条控制指令才会启动特定行为，那么在沙箱中这个后门程序将无法被启动和分析。
3.  沙箱不能记录所有事件。例如，恶意代码设置为等待一天才会去执行它的恶意行为，那么就可能会错过这个事件。
4.  恶意代码经常检测它是否运行在一个虚拟机里，并且如果检测到了虚拟机，恶意代码将会停止运行or表现异常。不是所有沙箱都能完善考虑这个问题
5.  恶意代码需要系统上有特定的注册表项or文件（而沙箱中没有）
6.  恶意代码是DLL时，一些导出函数可能不会被恰当地调用
7.  沙箱环境的os可能对恶意代码来说不正确
8.  沙箱不能告诉你恶意代码做了什么（它能报告基本功能，但是它不能告诉你恶意代码是一个SAM密文记录器 / 加密的键盘记录后门程序，这些要自己总结）


## 运行恶意代码

**没写完**

如何运行一个DLL

在所有的Windows版本中都包含 *rundll32.exe* -- 提供了一个运行DLL的平台

```shell
C:\>rundll32.exe DLLname,Export arguments
```

*Export*  值必须是一个DLL文件导出函数表中的韩树明or序号



## Process Monitor

Process Monitor --- 监控注册表 / 文件系统 / 网络 / 进程 / 线程

并不是所有数据都捕获，ex 一个用户态组件通过设备IO控制与内核套件进行通信的设备驱动行为 or 一些特定的图形界面调用，如SetWindowsHookEx

进程监视器-- 监控并记录(使用内存)所有能捕获的系统调用，所以不要时间太长避免耗尽内存使虚拟机崩溃

停止进程监视器捕获事件 File -- Capture Events

清空当前所有截获的事件 Edit -- Clear Display

### 进程监视器的显示

双击 --- 详细显示

### 进程监视器中的过滤



## 使用Process Explorer来查看进程



### 进程浏览器的显示

### 使用验证选项

### 比较字符串

### 使用Dependency Walker

### 分析恶意文档

## 使用Regshot来比较注册表快照

## 模拟网络

## 使用Wireshark进行数据包监听

## 使用INetSim

## 基础动态分析工具实践

## 小结

## 实验

 